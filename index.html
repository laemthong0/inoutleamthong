<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏´‡∏•‡∏°‡∏ó‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡πÄ‡∏Å‡∏©‡∏ï‡∏£</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Fonts & Style -->
  <style>
    /* ‡∏ã‡πà‡∏≠‡∏ô Banner ‡∏Ç‡∏≠‡∏á Google Apps Script (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ) */
    body > div[style*="background-color"] { display: none !important; }
    
    @font-face {
      font-family: 'Digital dream Fat';
      src: url('https://semicon.github.io/fonts/DigitaldreamFat.woff2') format('woff2');
      font-display: swap;
    }
    :root {
      --primary-color: #28a745; --secondary-color: #f1c40f; --dark-color: #2c3e50;
      --border-radius: 8px; --box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Kanit', sans-serif; }
    body { min-height: 100vh; display: flex; align-items: center; justify-content: center; background-color: #a4f8ab; padding: 15px; }
    .wrapper { background: rgba(255, 255, 255, 0.95); width: 100%; max-width: 400px; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
    .site-logo { height: 80px; margin-bottom: 15px; }
    .company-name { font-weight: 700; font-size: 1.8rem; margin: 0 0 15px; color: var(--dark-color); }
    .clock-container { background: #f8f9fa; padding: 15px; border-radius: var(--border-radius); margin-bottom: 20px; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }
    .clock { font-family: 'Digital dream Fat'; font-size: 2rem; color: #000; letter-spacing: 3px; background: linear-gradient(to bottom, #e9ecef, #dee2e6); padding: 10px 8px; border: 2px solid #adb5bd; border-radius: 5px; min-width: 90%; text-align: center; }
    .form-group { margin-bottom: 20px; }
    label { font-weight: 500; display: block; margin-bottom: 8px; color: var(--dark-color); }
    .btn-action { display: flex; gap: 10px; margin-bottom: 20px; }
    .btn { height: 45px; border-radius: var(--border-radius); font-weight: 500; flex: 1; }
    .btn-clockin { background-color: var(--primary-color); border-color: var(--primary-color); color: white; }
    .btn-clockout { background-color: var(--secondary-color); border-color: var(--secondary-color); color: #212529; }
    .msgBg { background: linear-gradient(135deg, #67B26F, #4ca2cd); color: white; }
    .alert { padding: 15px; border-radius: var(--border-radius); min-height: 60px; display: flex; align-items: center; justify-content: center; }
    .alert-info { background-color: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="text-center">
      <img src="https://img5.pic.in.th/file/secure-sv1/7088b986100a839eee3df494134be747.png"  alt="‡πÅ‡∏´‡∏•‡∏°‡∏ó‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡πÄ‡∏Å‡∏©‡∏ï‡∏£" class="site-logo">
      <h1 class="company-name">‡πÅ‡∏´‡∏•‡∏°‡∏ó‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡πÄ‡∏Å‡∏©‡∏ï‡∏£</h1>
    </div>
    <div class="clock-container text-center">
      <div id="MyClockDisplay" class="clock"></div>
    </div>
    <form id="myForm">
      <div class="form-group">
        <label for="employee">üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
        <select class="form-control select2" id="employee">
          <option value="" disabled selected>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</option>
        </select>
      </div>
      <div class="btn-action">
        <button type="button" class="btn btn-clockin" onclick="ClockIn()">üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</button>
        <button type="button" class="btn btn-clockout" onclick="ClockOut()">üî¥ ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô</button>
      </div>
      <div class="form-group">
        <div class="alert msgBg" role="alert" id="message"></div>
      </div>
    </form>
  </div>

  <script>
    // ------------------ START: CONFIGURATION ------------------
    // !!! ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: ‡∏ô‡∏≥ URL ‡∏Ç‡∏≠‡∏á Web App ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà !!!
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzQETxqoLA6CfSXU0AvEnUjGdqZP2Huq6ueuYiJoXcnsbFCvLd2MRtbrEEJOZMdIFNN/exec";
    // ------------------- END: CONFIGURATION -------------------

    const APP_CONFIG = {
      employeeCacheDuration: 300000, // 5 minutes cache
      lastEmployeeFetch: 0,
      employeeCache: null,
    };

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö API ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà ---

    function getEmployees(forceRefresh = false) {
      if (!forceRefresh && APP_CONFIG.employeeCache && (Date.now() - APP_CONFIG.lastEmployeeFetch < APP_CONFIG.employeeCacheDuration)) {
        updateEmployeeList(APP_CONFIG.employeeCache);
        return Promise.resolve(APP_CONFIG.employeeCache);
      }
      showLoading(true);
      return fetch(SCRIPT_URL + "?action=getEmployees")
        .then(response => {
          if (!response.ok) throw new Error('Network error while fetching employees.');
          return response.json();
        })
        .then(jsonResponse => {
          if (jsonResponse.status === 'success') {
            const data = Array.isArray(jsonResponse.data) ? jsonResponse.data : [];
            APP_CONFIG.lastEmployeeFetch = Date.now();
            APP_CONFIG.employeeCache = data;
            updateEmployeeList(data);
            return data;
          } else {
            throw new Error(jsonResponse.message || 'Failed to parse employee data.');
          }
        })
        .catch(error => {
          console.error('Error fetching employees:', error);
          showNotification('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ');
          updateEmployeeList([]); // Clear list on error
          return [];
        })
        .finally(() => {
          showLoading(false);
        });
    }

    async function sendClockAction(action, employee, gps) {
      const payload = { action, employee, gps };
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });
      if (!response.ok) throw new Error('Server returned an error.');
      
      const jsonResponse = await response.json();
      if (jsonResponse.status === 'success' && Array.isArray(jsonResponse.data)) {
        const item = jsonResponse.data[0];
        const statusText = action === 'clockIn' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' : '‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô';
        if (item[0] === 'SUCCESS') {
          showPopup(employee, item[1], statusText, item[3]);
        } else {
          showNotification(`‚ö†Ô∏è ${item[2] || ''} ${item[0]}`);
        }
        clearForm();
      } else {
        throw new Error(jsonResponse.message || `Failed to ${action}.`);
      }
    }
    
    async function ClockIn() {
      const employee = document.getElementById("employee").value;
      if (!employee) { showNotification('üö´üßë ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return; }
      
      showLoading(true);
      try {
        const gps = await getlocation();
        await sendClockAction('clockIn', employee, gps);
      } catch (error) {
        showNotification(`‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
      } finally {
        showLoading(false);
      }
    }
    
    async function ClockOut() {
      const employee = document.getElementById("employee").value;
      if (!employee) { showNotification('üö´üßë ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô'); return; }

      showLoading(true);
      try {
        const gps = await getlocation();
        await sendClockAction('clockOut', employee, gps);
      } catch (error) {
        showNotification(`‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
      } finally {
        showLoading(false);
      }
    }
    
    // --- ‡∏™‡πà‡∏ß‡∏ô Helper Functions ‡πÄ‡∏î‡∏¥‡∏° ---
    function updateEmployeeList(employees) {
        const employeeSelect = $("#employee");
        employeeSelect.empty();
        if (employees.length === 0) {
            employeeSelect.append('<option value="" disabled selected>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</option>');
        } else {
            employeeSelect.append('<option value="" disabled selected>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...</option>');
            employees.filter(item => item[0] && item[0].trim() !== '').forEach(item => {
                const name = item[0].trim();
                employeeSelect.append(new Option(name, name));
            });
        }
        employeeSelect.trigger('change');
    }

    function showLoading(show) {
      if (show) {
        $('#message').html('<span class="spinner-border spinner-border-sm me-2"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...');
        document.getElementById("message").className = "alert alert-info";
      } else {
        document.getElementById("message").innerHTML = '‚òÄÔ∏è ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç';
        document.getElementById("message").className = "alert msgBg";
      }
    }

    async function getlocation() {
        return new Promise((resolve, reject) => {
            if (!navigator.geolocation) {
                return reject(new Error("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation"));
            }
            navigator.geolocation.getCurrentPosition(
                (position) => resolve([position.coords.latitude, position.coords.longitude]),
                (err) => reject(new Error(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ: ${err.message}`)),
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        });
    }

    function showTime() {
      const date = new Date();
      let h = date.getHours(); let m = date.getMinutes(); let s = date.getSeconds();
      h = h < 10 ? "0" + h : h; m = m < 10 ? "0" + m : m; s = s < 10 ? "0" + s : s;
      document.getElementById("MyClockDisplay").innerText = `${h}:${m}:${s}`;
      setTimeout(showTime, 1000);
    }
    
    function showNotification(message) {
      $('#message').html(message);
      document.getElementById("message").className = "alert alert-danger";
    }

    function clearForm() {
      // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏î‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å
      setTimeout(() => {
        document.getElementById('message').innerHTML = '‚òÄÔ∏è ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç';
        document.getElementById("message").className = "alert msgBg";
      }, 5000);
    }

    function showPopup(employee, time, status, location) {
      Swal.fire({
        icon: 'success',
        title: '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
        html: `<div style="text-align: left;">
            <p><strong>üë§ ‡∏ä‡∏∑‡πà‡∏≠:</strong> ${employee}</p>
            <p><strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${time.replace('<br>', ' ')}</p>
            <p><strong>üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${status}</p>
            <p><strong>üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> ${location}</p>
          </div>`,
        confirmButtonText: '‡∏õ‡∏¥‡∏î',
        confirmButtonColor: '#28a745'
      });
    }
    
    $(document).ready(function () {
      document.getElementById('message').innerHTML = '‚òÄÔ∏è ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç';
      $('.select2').select2({ theme: 'bootstrap-5', placeholder: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...', width: '100%'});
      getEmployees();
      showTime();
    });
  </script>
</body>
</html>
