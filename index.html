<!DOCTYPE html>
<html lang="th">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://ajax.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://semicon.github.io; font-src 'self' https://semicon.github.io; img-src 'self' https://img5.pic.in.th data:; connect-src 'self' https://script.google.com https://script.googleusercontent.com;">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏´‡∏•‡∏°‡∏ó‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡πÄ‡∏Å‡∏©‡∏ï‡∏£</title>

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Fonts & Style -->
  <style>
    @font-face {
      font-family: 'Digital dream Fat';
      src: url('https://semicon.github.io/fonts/DigitaldreamFat.woff2')  format('woff2'),
           url('https://semicon.github.io/fonts/DigitaldreamFat.woff')  format('woff');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --primary-color: #28a745;
      --secondary-color: #f1c40f;
      --accent-color: #3498db;
      --dark-color: #2c3e50;
      --light-color: #f8f9fa;
      --danger-color: #e74c3c;
      --text-color: #333;
      --border-radius: 8px;
      --box-shadow: 0 5px 15px rgba(0,0,0,0.15);
    }

    * {
      margin: 0; padding: 0; box-sizing: border-box;
      font-family: 'K2D', 'Kanit', sans-serif;
    }

    body {
      font-size: 1.05rem;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #a4f8ab;
      background-size: cover;
      color: var(--text-color);
      padding: 15px;
    }

    .site-logo {
      width: auto; height: 80px; margin-bottom: 15px;
    }

    .company-name {
      font-family: 'Kanit', sans-serif;
      font-weight: 700;
      font-size: 1.8rem;
      margin: 0 0 15px;
      color: var(--dark-color);
      text-shadow: 1px 1px 2px rgba(255,255,255,0.7);
    }

    .msgBg {
      background: linear-gradient(135deg, #67B26F, #4ca2cd);
      color: white; text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
      padding: 12px; border-radius: var(--border-radius);
      font-weight: 500;
    }

    .wrapper {
      background: rgba(255, 255, 255, 0.92); width: 100%; max-width: 400px;
      padding: 25px; border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
    }

    .clock-container {
      background: #f8f9fa; padding: 15px; border-radius: var(--border-radius);
      margin-bottom: 20px; box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    }

    .clock {
      font-family: 'Digital dream Fat'; font-size: 2rem; color: #000;
      letter-spacing: 3px; text-shadow: 1px 1px 2px rgba(0, 128, 0, 0.5), 0 0 15px rgba(0, 128, 0, 0.3);
      background: linear-gradient(to bottom, #e9ecef, #dee2e6);
      padding: 10px 8px; border: 2px solid #adb5bd; border-radius: 5px;
      display: inline-block; min-width: 90%; text-align: center;
      box-shadow: inset 0 0 8px rgba(0,0,0,0.2);
    }

    .form-group { margin-bottom: 20px; }

    label {
      font-weight: 500; display: block; margin-bottom: 8px;
      color: var(--dark-color);
    }

    .form-control {
      height: 45px; border-radius: var(--border-radius);
      border: 1px solid #ced4da; padding: 0.5rem 1rem;
    }

    .btn-action {
      display: flex; 
      gap: 10px; 
      margin-bottom: 20px;
      flex-wrap: nowrap;
    }

    .btn {
      height: 45px; 
      border-radius: var(--border-radius);
      font-weight: 500; 
      display: flex;
      align-items: center; 
      justify-content: center;
      transition: all 0.3s ease;
      flex: 1;
    }

    .btn-clockin {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-clockin:hover {
      background-color: #1e7e34;
      transform: scale(1.05);
    }

    .btn-clockout {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color); 
      color: #212529;
    }

    .btn-clockout:hover {
      background-color: #d39e00;
      transform: scale(1.05);
    }

    .alert {
      padding: 15px; border-radius: var(--border-radius);
      margin-bottom: 0; min-height: 60px; display: flex;
      align-items: center; justify-content: center;
      text-align: center;
    }

    .alert-info {
      background-color: #d1ecf1; border-color: #bee5eb;
      color: #0c5460;
    }

    .notification-icon { margin-right: 8px; }

    @media (max-width: 575.98px) {
      .wrapper { padding: 20px 15px; }
      .company-name { font-size: 1.6rem; }
      .clock { font-size: 1.8rem; min-width: 95%; }
      .btn-action { flex-direction: row; }
    }

    .swal2-popup-custom .swal2-html-container {
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.95rem;
      line-height: 1.6;
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
    }
    
    .connection-status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 500;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    
    .connection-status i {
      font-size: 16px;
    }
    
    .connection-status.online {
      background-color: #28a745;
      color: white;
    }
    
    .connection-status.offline {
      background-color: #dc3545;
      color: white;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <div class="text-center">
      <img src="https://img5.pic.in.th/file/secure-sv1/7088b986100a839eee3df494134be747.png"  alt="‡πÅ‡∏´‡∏•‡∏°‡∏ó‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡πÄ‡∏Å‡∏©‡∏ï‡∏£" class="site-logo">
      <h1 class="company-name">‡πÅ‡∏´‡∏•‡∏°‡∏ó‡∏≠‡∏á‡∏Å‡∏¥‡∏à‡πÄ‡∏Å‡∏©‡∏ï‡∏£</h1>
    </div>
    <div class="clock-container text-center">
      <div id="MyClockDisplay" class="clock"></div>
    </div>
    <form id="myForm">
      <div class="form-group">
        <label for="employee">
          üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
        </label>
        <select class="form-control" id="employee">
          <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</option>
        </select>
      </div>
      <div class="btn-action">
        <button type="button" class="btn btn-clockin" onclick="ClockIn()">
          üü¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô
        </button>
        <button type="button" class="btn btn-clockout" onclick="ClockOut()">
          üî¥ ‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô
        </button>
      </div>
      <div class="form-group">
        <div class="alert msgBg" role="alert" id="message"></div>
      </div>
    </form>
  </div>

  <script>
    // =========================================================================
    // == CONFIGURATION: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Web App ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ==
    // =========================================================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzQETxqoLA6CfSXU0AvEnUjGdqZP2Huq6ueuYiJoXcnsbFCvLd2MRtbrEEJOZMdIFNN/exec'; // <--- ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ‡πÉ‡∏™‡πà URL ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
    // =========================================================================

    // Configuration
    const APP_CONFIG = {
      maxAttempts: 5,
      lockoutDuration: 3600000,
      sessionTimeout: 1800000,
      employeeCacheDuration: 300000,
      lastEmployeeFetch: 0,
      employeeCache: null,
      apiTimeout: 15000, // Increased timeout to 15s
      isFetching: false,
      pendingRequests: []
    };

    let attemptCount = 0;
    let lastAttemptTime = 0;
    let sessionStartTime = Date.now();

    function checkSession() {
      if (Date.now() - sessionStartTime > APP_CONFIG.sessionTimeout) {
        showNotification('<i class="fas fa-exclamation-triangle notification-icon"></i> ‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà');
        return false;
      }
      return true;
    }

    function checkRateLimit() {
      const currentTime = Date.now();
      if (currentTime - lastAttemptTime > APP_CONFIG.lockoutDuration) {
        attemptCount = 0;
      }
      if (attemptCount >= APP_CONFIG.maxAttempts) {
        const remainingTime = Math.ceil((APP_CONFIG.lockoutDuration - (currentTime - lastAttemptTime)) / 60000);
        showNotification(`<i class="fas fa-ban notification-icon"></i> ‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ ${remainingTime} ‡∏ô‡∏≤‡∏ó‡∏µ`);
        return false;
      }
      attemptCount++;
      lastAttemptTime = currentTime;
      return true;
    }

    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      return input.replace(/[<>\"'&]/g, match => ({'<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;','&': '&amp;'}[match]));
    }

    function validateGPS(gps) {
      if (!Array.isArray(gps) || gps.length !== 2) return false;
      const [lat, lng] = gps;
      if (typeof lat !== 'number' || typeof lng !== 'number' || isNaN(lat) || isNaN(lng)) return false;
      if (lat < 5.5 || lat > 20.5 || lng < 97.0 || lng > 106.0) {
        console.warn('GPS coordinates outside Thailand range');
        return false;
      }
      return true;
    }

    const connectionStatus = document.createElement('div');
    connectionStatus.className = 'connection-status';
    document.body.appendChild(connectionStatus);
    
    function updateConnectionStatus() {
      const isOnline = navigator.onLine;
      if (isOnline) {
        connectionStatus.className = 'connection-status online';
        connectionStatus.innerHTML = '<i class="fas fa-wifi"></i> ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
      } else {
        connectionStatus.className = 'connection-status offline';
        connectionStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå';
      }
      return isOnline;
    }
    
    window.addEventListener('online', () => {
        updateConnectionStatus();
        if (Date.now() - APP_CONFIG.lastEmployeeFetch > APP_CONFIG.employeeCacheDuration) {
            getEmployees(true);
        }
    });
    window.addEventListener('offline', updateConnectionStatus);

    function formatEmployee(employee) { return !employee.id ? employee.text : $('<span>').text(employee.text); }
    function formatEmployeeSelection(employee) { return !employee.id ? employee.text : $('<span>').text(employee.text); }
    
    $(document).ready(function () {
      document.getElementById('message').innerHTML = '‚òÄÔ∏è ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç';
      updateConnectionStatus();
      
      getEmployees().then(() => {
        const savedEmployee = localStorage.getItem('selectedEmployee');
        if (savedEmployee) {
          $('#employee').val(savedEmployee).trigger('change');
        }
      });
    });

    function isCacheValid() {
      return APP_CONFIG.employeeCache && (Date.now() - APP_CONFIG.lastEmployeeFetch) < APP_CONFIG.employeeCacheDuration;
    }
    
    async function apiFetch(action, payload = null) {
      if (SCRIPT_URL === 'YOUR_WEB_APP_URL_HERE') {
        throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ SCRIPT_URL ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå index.html ‡∏Å‡πà‡∏≠‡∏ô');
      }
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), APP_CONFIG.apiTimeout);

      let response;
      if (payload) { // POST request
        response = await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'cors',
          signal: controller.signal,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, ...payload })
        });
      } else { // GET request
        response = await fetch(`${SCRIPT_URL}?action=${action}`, {
          method: 'GET',
          mode: 'cors',
          signal: controller.signal,
        });
      }

      clearTimeout(timeoutId);
      if (!response.ok) {
        throw new Error(`Network response was not ok: ${response.statusText}`);
      }
      return await response.json();
    }

    async function getEmployees(forceRefresh = false) {
      if (!forceRefresh && isCacheValid()) {
        updateEmployeeList(APP_CONFIG.employeeCache);
        return Promise.resolve(APP_CONFIG.employeeCache);
      }

      if (APP_CONFIG.isFetching) return;
      APP_CONFIG.isFetching = true;
      showLoading(true);

      try {
        const result = await apiFetch('getEmployees');
        if (result.status === 'success' && Array.isArray(result.data)) {
          const employees = result.data;
          APP_CONFIG.lastEmployeeFetch = Date.now();
          APP_CONFIG.employeeCache = employees;
          updateEmployeeList(employees); // This now also initializes Select2
          return employees;
        } else {
          throw new Error(result.message || 'Invalid data format from server');
        }
      } catch (error) {
        console.error('Error fetching employees:', error);
        showNotification('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á');
        if (Array.isArray(APP_CONFIG.employeeCache)) {
          updateEmployeeList(APP_CONFIG.employeeCache); // show stale data if available
        }
        return [];
      } finally {
        APP_CONFIG.isFetching = false;
        showLoading(false);
      }
    }
    
    function updateEmployeeList(employees) {
      if (!Array.isArray(employees)) return;

      const employeeSelect = $("#employee");
      const currentValue = employeeSelect.val();

      if (employeeSelect.hasClass('select2-hidden-accessible')) {
          employeeSelect.select2('destroy');
      }

      employeeSelect.empty().append('<option></option>'); // Use an empty option for Select2 placeholder
      
      const newOptions = employees
        .filter(item => item && item[0] && item[0].trim() !== '')
        .map(item => ({
          value: item[0].trim(),
          text: item[0].trim()
        }));

      newOptions.forEach(option => {
        employeeSelect.append(new Option(option.text, option.value));
      });
      
      initSelect2(employeeSelect);
      
      if (currentValue && newOptions.some(opt => opt.value === currentValue)) {
          employeeSelect.val(currentValue).trigger('change');
      }
    }
    
    function initSelect2(element) {
      element.select2({
        theme: 'bootstrap-5',
        placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...',
        allowClear: true,
        width: '100%',
        minimumInputLength: 1,
        language: {
          noResults: () => '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤',
          searching: () => '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...',
          inputTooShort: (args) => `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ ${args.minimum} ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£`,
          errorLoading: () => '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
        },
        templateResult: formatEmployee,
        templateSelection: formatEmployeeSelection,
        escapeMarkup: (markup) => markup
      });
    }

    function showLoading(show) {
      const messageEl = $('#message');
      if (show) {
        messageEl.html('<div class="d-flex align-items-center"><span class="spinner-border spinner-border-sm text-light me-2"></span> ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</div>');
        messageEl.removeClass("msgBg").addClass("alert-info");
      } else {
        messageEl.html('‚òÄÔ∏è ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç');
        messageEl.removeClass("alert-info").addClass("msgBg");
      }
    }

    async function handleClocking(action) {
        if (!checkSession() || !checkRateLimit()) return;
        
        const employeeEl = document.getElementById("employee");
        if (!employeeEl || !employeeEl.value) {
            showNotification('üö´üßë ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô');
            return;
        }

        const employee = sanitizeInput(employeeEl.value);
        showLoading(true);

        try {
            const gps = await getlocation();
            if (!validateGPS(gps)) {
                showNotification('üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á GPS ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                showLoading(false);
                return;
            }

            const result = await apiFetch(action, { employee, gps });
            showLoading(false);

            if (result.status === 'SUCCESS') {
                showPopup(employee, result.time, (action === 'clockIn' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô' : '‡πÄ‡∏•‡∏¥‡∏Å‡∏á‡∏≤‡∏ô'), result.location);
                clearForm();
            } else {
                showNotification(`‚ö†Ô∏è ${result.message}`);
                clearForm();
            }
        } catch (error) {
            showLoading(false);
            if (error.name !== 'AbortError' && !(error instanceof DOMException && error.message.includes('permission'))) {
                showNotification(`‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`);
            }
        }
    }

    async function ClockIn() { await handleClocking('clockIn'); }
    async function ClockOut() { await handleClocking('clockOut'); }

    async function getlocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          return reject(new DOMException("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Geolocation)"));
        }

        navigator.geolocation.getCurrentPosition(
          (position) => {
            const { latitude, longitude } = position.coords;
            if (!latitude || !longitude) {
               return reject(new DOMException("‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"));
            }
            resolve([latitude, longitude]);
          },
          (err) => reject(err),
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      }).catch(err => {
        let title, htmlContent;
        const isLineBrowser = navigator.userAgent.toLowerCase().includes("line");
        const baseInstructions = '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br><br><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</strong><br>1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <b>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings)</b> ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå<br>2. ‡∏°‡∏≠‡∏á‡∏´‡∏≤ <b>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå (Site settings)</b><br>3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Location)</b><br>4. ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡πá‡∏ö‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ';

        switch (err.code) {
          case 1:
            title = "‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
            htmlContent = isLineBrowser 
              ? `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ LINE ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ<br><br><strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ LINE:</strong><br>1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <b>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings)</b> ‡∏Ç‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠<br>2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô (Apps)</b> > <b>LINE</b><br>3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (Permissions)</b><br>4. ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô <b>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Location)</b>` 
              : baseInstructions;
            break;
          case 2:
            title = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ";
            htmlContent = "‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡∏≠‡πà‡∏≠‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏•‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á";
            break;
          case 3:
            title = "‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
            htmlContent = "‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
            break;
          default:
            title = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
            htmlContent = `‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (Error: ${err.message})`;
        }
        Swal.fire({ icon: 'warning', title: '‚ö†Ô∏è ' + title, html: `<div style="text-align: left; padding: 10px;">${htmlContent}</div>`, confirmButtonText: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß', confirmButtonColor: '#d33' });
        throw err;
      });
    }

    function showTime() {
      const date = new Date();
      let h = date.getHours(), m = date.getMinutes(), s = date.getSeconds();
      h = h < 10 ? "0" + h : h;
      m = m < 10 ? "0" + m : m;
      s = s < 10 ? "0" + s : s;
      document.getElementById("MyClockDisplay").innerText = `${h}:${m}:${s}`;
      setTimeout(showTime, 1000);
    }

    showTime();

    function showNotification(message) {
      $('#message').html(message);
      $("#message").removeClass("msgBg").addClass("alert-info");
    }

    function clearForm() {
      setTimeout(() => {
        $('#message').html('‚òÄÔ∏è ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∏‡∏Ç');
        $("#message").removeClass("alert-info").addClass("msgBg");
      }, 5000);
    }

    function showPopup(employee, time, status, location) {
      Swal.fire({
        icon: 'success',
        title: '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
        html: `
          <div style="text-align: left;">
            <p><strong>üë§ ‡∏ä‡∏∑‡πà‡∏≠:</strong> ${sanitizeInput(employee)}</p>
            <p><strong>‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${time.replace(/<br>/g, ' ')}</p>
            <p><strong>üìã ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> ${sanitizeInput(status)}</p>
            <p><strong>üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:</strong> ${sanitizeInput(location)}</p>
          </div>
        `,
        confirmButtonText: '‡∏õ‡∏¥‡∏î',
        confirmButtonColor: '#28a745'
      });
    }

    $("#employee").on("change", function () {
      localStorage.setItem('selectedEmployee', this.value);
    });
  </script>
</body>
</html>
